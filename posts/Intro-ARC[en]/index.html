<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta property="og:site_name" content="vickcoo"/><link rel="canonical" href="https://vickcoo.github.io/posts/Intro-ARC%5Ben%5D"/><meta name="twitter:url" content="https://vickcoo.github.io/posts/Intro-ARC%5Ben%5D"/><meta property="og:url" content="https://vickcoo.github.io/posts/Intro-ARC%5Ben%5D"/><title>Leave Memory Troubles to ARC | vickcoo</title><meta name="twitter:title" content="Leave Memory Troubles to ARC | vickcoo"/><meta property="og:title" content="Leave Memory Troubles to ARC | vickcoo"/><meta name="description" content="In Swift, ARC is an essential concept responsible for memory management, ensuring that objects no longer in use are properly released. This article will provide a detailed explanation of how ARC works and how to avoid common memory leak issues."/><meta name="twitter:description" content="In Swift, ARC is an essential concept responsible for memory management, ensuring that objects no longer in use are properly released. This article will provide a detailed explanation of how ARC works and how to avoid common memory leak issues."/><meta property="og:description" content="In Swift, ARC is an essential concept responsible for memory management, ensuring that objects no longer in use are properly released. This article will provide a detailed explanation of how ARC works and how to avoid common memory leak issues."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to vickcoo"/><meta name="twitter:image" content="https://vickcoo.github.io/images"/><meta property="og:image" content="https://vickcoo.github.io/images"/></head><body class="item-page"><header><div class="wrapper"><a href="/" class="site-name">vickcoo</a><p>iOS Developer</p><nav><ul><li><a href="/posts" class="selected">Posts</a></li><li><a href="/about">About</a></li><li><a href="/message">Message</a></li></ul></nav></div></header><div class="wrapper"><article><h1>Leave Memory Troubles to ARC</h1><div class="metadata"><ul class="tag-list"><li><a href="/tags/swift">swift</a></li></ul><span class="date">Published on Sep 20, 2023</span></div><div class="language-switcher-container"><ul><li><a href="/posts/Intro-ARC[en]" class="selected">en</a></li><li><a href="/posts/Intro-ARC[zh-TW]">zh-TW</a></li></ul></div><div class="content"><p><a href="https://en.wikipedia.org/wiki/Automatic_Reference_Counting">Automatic Reference Counting</a>, abbreviated as <strong>ARC</strong>, is a key feature of the Swift programming language. It is responsible for managing the lifecycle of objects in memory to ensure efficient allocation and deallocation of memory resources. ARC works automatically and lets you even do not manually manage memory, reducing the risks of memory leaks and improper deallocation.</p><ul><li>Swift automatically manages memory and does not need manual intervention. However, you should consider the relationships between objects to prevent memory leaks.</li><li>Every time an instance of a class is created, ARC allocates memory to store all the data about that instance.</li><li>ARC automatically releases objects in memory when their lifetime ends.</li></ul><h2>How ARC Works</h2><p>Its operation is simple. When an object is created, its ARC is initialized to 1. When new references point to this object, the ARC is incremented by 1. When a reference no longer exists, the ARC is decremented by 1. It's a straightforward addition and subtraction!</p><p>Let's explain this in two different ways:</p><h3>Text Version</h3><p>One day, David was walking down the street and saw a shiny <code>iPhone XR</code>. He was attracted to its features and appearance, so he decided to take it and became its owner. At this point, because David referenced the <code>iPhone XR</code>, the iPhone's ARC increased to 2.</p><p>After a while, John also walked by and saw the <code>iPhone XR</code>. He claimed that the phone belonged to him and requested it from David. Now, the iPhone's ARC became 3.</p><p>However, this situation didn't last long. Shortly after, a police officer appeared, investigated the phone's origin, and found out that the iPhone didn't belong to David or John. They were both informed that they couldn't possess the phone because it didn't belong to either of them. As a result, both David and John canceled their references to the iPhone, and the ARC quickly decreased to 1.</p><p>Finally, since no one knew who the phone belonged to, it was decided to be destroyed, and the <code>iPhone XR</code> also canceled its reference to the iPhone. So, the ARC became zero, and it disappeared from the world (released from memory).</p><h3>Code Version</h3><p>The classes <code>Phone</code> and <code>Person</code> used in the story can be found in the following code:</p><pre><code><span class="comment">// One day, David was walking down the street and saw a shiny `iPhone XR`. He was attracted to its features and appearance, so he decided to take it and became its owner. At this point, because David referenced the `iPhone XR`, the iPhone's ARC increased to 2.</span>
<span class="keyword">var</span> iPhone: <span class="type">Phone</span>? = <span class="type">Phone</span>(name: <span class="string">"iPhone XR"</span>) <span class="comment">// ARC = 1</span>
<span class="keyword">var</span> david: <span class="type">Person</span> = <span class="type">Person</span>(name: <span class="string">"David"</span>)
david.<span class="property">phone</span> = iPhone <span class="comment">// ARC = 2

// After a while, John also walked by and saw the `iPhone XR`. He claimed that the phone belonged to him and requested it from David. Now, the iPhone's ARC became 3.</span>
<span class="keyword">var</span> john: <span class="type">Person</span> = <span class="type">Person</span>(name: <span class="string">"John"</span>)
john.<span class="property">phone</span> = iPhone <span class="comment">// ARC = 3

// However, this situation didn't last long. Shortly after, a police officer appeared, investigated the phone's origin, and found out that the iPhone didn't belong to David or John. They were both informed that they couldn't possess the phone because it didn't belong to either of them. As a result, both David and John canceled their references to the iPhone, and the ARC quickly decreased to 1.</span>
david.<span class="property">phone</span> = <span class="keyword">nil</span> <span class="comment">// ARC = 2</span>
john.<span class="property">phone</span> = <span class="keyword">nil</span> <span class="comment">// ARC = 1

// Finally, since no one knew who the phone belonged to, it was decided to be destroyed, and the `iPhone XR` also canceled its reference to the iPhone. So, the ARC became zero, and it disappeared from the world (released from memory).</span>
iPhone = <span class="keyword">nil</span> <span class="comment">// ARC = 0</span>
</code></pre><pre><code><span class="keyword">class</span> Person {
    <span class="keyword">var</span> name: <span class="type">String</span>
    <span class="keyword">var</span> phone: <span class="type">Phone</span>?
    <span class="keyword">init</span> (name: <span class="type">String</span>) {
        <span class="keyword">self</span>.<span class="property">name</span> = name
    }
}

<span class="keyword">class</span> Phone {
    <span class="keyword">var</span> name: <span class="type">String</span>
    <span class="keyword">init</span>(name: <span class="type">String</span>) {
        <span class="keyword">self</span>.<span class="property">name</span> = name
    }
}
</code></pre><h2>What is a Retain Cycle, and How Does It Happen?</h2><p>A Retain Cycle refers to an object existing in memory without a way to be released. It occurs when two objects strong reference each other. The following examples explain this.</p><h3>Story Version</h3><p>In a distant universe, two stars existed. They attracted each other, as if destined to shine together, but their meeting was not as simple as it seemed.</p><p>My girlfriend and I loved stargazing, and one day, we found two incredibly beautiful stars. We decided to make them ours and named them <code>Shelly</code> and <code>Ben</code>. These two stars attracted each other, creating a mysterious connection, much like a romantic relationship. They established an invisible link in the universe, combining their radiance.</p><p>One day, my girlfriend and I lost interest in stargazing and decided to disconnect from those stars. However, the radiance of the stars didn't disappear. This happened because these two stars had formed a strong bond, leaving a faint line of radiance in the universe, causing them to reference each other.</p><p>Even though we no longer observed these stars and couldn't find them, their radiance continued to exist because ARC maintained their existence. They would shine forever in the universe, unable to be referenced, much like old lovers who could never meet again.</p><p>This story reflects how Automatic Reference Counting (ARC) operates. Even when the reference relationship between objects is severed, if ARC still holds references to them, they will persist, unable to be deallocated. ARC ensures correct memory management but reminds us to handle references carefully to avoid unexpected situations.</p><h3>Code Version</h3><p>The classes <code>Star</code> and <code>Person</code> used in the story can be found in the following code:</p><pre><code><span class="keyword">var</span> me: <span class="type">Person</span> = <span class="type">Person</span>(name: <span class="string">"me"</span>)
<span class="keyword">var</span> girlfriend: <span class="type">Person</span> = <span class="type">Person</span>(name: <span class="string">"girlfriend"</span>)
<span class="comment">// We loved stargazing, and one day, we found two incredibly beautiful stars, and we decided to make them ours and named them `Shelly` and `Ben`</span>
var shelly: <span class="type">Star</span> = <span class="type">Star</span>(name: <span class="string">"Shelly"</span>) <span class="comment">// shelly ARC = 1</span>
<span class="keyword">var</span> ben: <span class="type">Star</span> = <span class="type">Star</span>(name: <span class="string">"Ben"</span>) <span class="comment">// ben ARC = 1</span>

me.<span class="property">star</span> = ben
girlfriend.<span class="property">star</span> = shelly

<span class="comment">// These two stars attracted each other, creating a mysterious connection, much like a romantic relationship. They established an invisible link in the universe, combining their radiance.</span>
ben.<span class="property">linkStar</span> = shelly <span class="comment">// ben ARC = 2</span>
shelly.<span class="property">linkStar</span> = ben <span class="comment">// shelly ARC = 2

// One day, my girlfriend and I lost interest in stargazing and decided to disconnect from those stars.</span>
me.<span class="property">star</span> = <span class="keyword">nil</span> <span class="comment">// ben ARC = 1</span>
girlfriend.<span class="property">star</span> = <span class="keyword">nil</span> <span class="comment">// shelly ARC = 1

// However, the radiance of the stars didn't disappear. This happened because these two stars had formed a strong bond, leaving a faint line of radiance in the universe, causing them to reference each other.
// Even though we no longer observed these stars and couldn't find them, their radiance continued to exist because ARC maintained their existence. They would shine forever in the universe, unable to be referenced, much like old lovers who could never meet again.
// This story illustrates the operation of Automatic Reference Counting (ARC). Even when the reference relationships between objects have been severed, if ARC still holds references to them, they will continue to exist, unable to be deallocated. ARC ensures proper memory management but also reminds us to handle references carefully to prevent unexpected situations.</span>
</code></pre><pre><code><span class="keyword">class</span> Person {
    <span class="keyword">var</span> name: <span class="type">String</span>
    <span class="keyword">var</span> star: <span class="type">Star</span>?
    <span class="keyword">init</span>(name: <span class="type">String</span>) {
        <span class="keyword">self</span>.<span class="property">name</span> = name
    }
}

<span class="keyword">class</span> Star {
    <span class="keyword">var</span> name: <span class="type">String</span>
    <span class="keyword">var</span> linkStar: <span class="type">Star</span>?
    <span class="keyword">init</span>(name: <span class="type">String</span>) {
        <span class="keyword">self</span>.<span class="property">name</span> = name
    }
}
</code></pre><h2>How to Avoid Memory Leaks</h2><p>As mentioned earlier, a Retain Cycle can lead to Memory Leaks.</p><ul><li>A Retain Cycle occurs with strong references between two objects.</li><li>A Memory Leak happens when an object exists in memory, but the program can't access it or release it.</li></ul><p>To avoid these issues, two keywords come to the rescue. Both methods involve preventing the object from being counted in the ARC:</p><p>The first one is <strong>weak</strong>. You can use it by adding <code>weak</code> in front of the variable declaration, like this:</p><pre><code><span class="keyword">weak var</span> star: <span class="type">Star</span>?
</code></pre><p>The second one is <strong>unowned</strong>. It is similar to <code>weak</code> but without the optionality. You can use it when you're sure that the object won't become <code>nil</code> before its lifecycle ends:</p><pre><code><span class="keyword">unowned var</span> star: <span class="type">Star</span>
</code></pre><p>In summary:</p><ul><li>Use <code>weak</code> with <code>optional</code> variables.</li><li>Use <code>unowned</code> with <code>non-optional</code> variables.</li></ul><h2>Reference</h2><ul><li><a href="https://docs.swift.org/swift-book/documentation/the-swift-programming-language/automaticreferencecounting/">The Swift Programming Language (5.9) - Automatic Reference Counting</a></li><li><a href="https://chunyili200556.medium.com/">ChunYi LI</a> 的 <a href="https://medium.com/one-two-swift/arc-%E8%A8%98%E6%86%B6%E9%AB%94%E7%AE%A1%E7%90%86-weak-unowned-b3f5ae4239c7">Swift基礎 — ARC 記憶體管理Weak 、Unowned</a></li></ul></div></article><div class="comment-container"><script src="https://utteranc.es/client.js" repo="vickcoo/vickcoo.github.io.comment" issue-term="title" theme="github-light" crossorigin="anonymous" async></script></div></div><footer><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>